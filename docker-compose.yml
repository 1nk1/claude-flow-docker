services:
  claude-flow:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: claude-flow-alpha
    hostname: claude-flow

    volumes:
      - ${PROJECT_PATH}:/workspace/project
      - claude-flow-hive:/workspace/.hive-mind
      - claude-flow-swarm:/workspace/.swarm
      - claude-flow-memory:/workspace/memory
      - claude-flow-coordination:/workspace/coordination
      - ./config/.claude:/workspace/.claude
      - ${DESKTOP_FILES_PATH}:/workspace/files
      - ./logs:/workspace/logs

    ports:
      - "${MCP_SERVER_PORT:-8811}:8811"

    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_TO_FILE=${LOG_TO_FILE:-true}
      - LOG_FILE=/workspace/logs/claude-flow.log
      - CLAUDE_FLOW_LOG_LEVEL=${CLAUDE_FLOW_LOG_LEVEL:-info}
      - CLAUDE_FLOW_PROJECT=${CLAUDE_FLOW_PROJECT}
      - CLAUDE_FLOW_HOME=${CLAUDE_FLOW_HOME}
      - CLAUDE_FLOW_STORAGE=${CLAUDE_FLOW_STORAGE}
      - NODE_ENV=${NODE_ENV:-production}
      - MCP_SERVER_MODE=${MCP_SERVER_MODE:-stdio}
      - MCP_SERVER_PORT=${MCP_SERVER_PORT:-8811}
      - SQLITE_TMPDIR=${SQLITE_TMPDIR}

    networks:
      - claude-flow-net

    deploy:
      resources:
        limits:
          cpus: "${CONTAINER_CPU_LIMIT:-2}"
          memory: "${CONTAINER_MEMORY_LIMIT:-4G}"
        reservations:
          cpus: "${CONTAINER_CPU_RESERVATION:-1}"
          memory: "${CONTAINER_MEMORY_RESERVATION:-2G}"

    restart: unless-stopped
    stdin_open: true
    tty: true

  flow-nexus:
    image: node:18-alpine
    container_name: flow-nexus-bridge
    volumes:
      - ${PROJECT_PATH}:/workspace/project
      - flow-nexus-data:/data
    environment:
      - FLOW_NEXUS_API_URL=https://flow-nexus.ruv.io
    networks:
      - claude-flow-net
    profiles:
      - nexus
    command: tail -f /dev/null

volumes:
  claude-flow-hive:
  claude-flow-swarm:
  claude-flow-memory:
  claude-flow-coordination:
  flow-nexus-data:

networks:
  claude-flow-net:
    driver: bridge

