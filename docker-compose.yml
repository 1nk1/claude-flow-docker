services:
  claude-flow:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: claude-flow-alpha
    hostname: claude-flow

    # Volumes for persistent storage
    volumes:
      # Project working directory (bind mount for file access)
      - ./project:/workspace/project

      # Persistent storage for Claude-Flow
      - claude-flow-hive:/workspace/.hive-mind
      - claude-flow-swarm:/workspace/.swarm
      - claude-flow-memory:/workspace/memory
      - claude-flow-coordination:/workspace/coordination

      # Configuration (optional)
      - ./config/.claude:/workspace/.claude

      # Logs
      - ./logs:/workspace/logs

    # Environment variables
    environment:
      - NODE_ENV=development
      - CLAUDE_FLOW_HOME=/workspace
      - CLAUDE_FLOW_PROJECT=/workspace/project
      - CLAUDE_FLOW_LOG_LEVEL=debug
      - CLAUDE_FLOW_DEBUG=true
      - CLAUDE_FLOW_VERBOSE=true
      - MCP_SERVER_MODE=stdio
      - MCP_DEBUG=true
      - MCP_LOG_LEVEL=debug
      - SQLITE_TMPDIR=/workspace/.swarm

    # Network
    networks:
      - claude-flow-net

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "${CONTAINER_CPU_LIMIT}"
          memory: "${CONTAINER_MEMORY_LIMIT}"
        reservations:
          cpus: "${CONTAINER_CPU_RESERVATION}"
          memory: "${CONTAINER_MEMORY_RESERVATION}"
    # Restart policy
    restart: unless-stopped

    # Stdin/stdout for MCP communication
    stdin_open: true
    tty: true

    # Command to keep alive
    command: tail -f /dev/null

  # Optional service for Flow Nexus Cloud (if needed)
  flow-nexus:
    image: node:18-alpine
    container_name: flow-nexus-bridge
    volumes:
      - ./project:/workspace/project
      - flow-nexus-data:/data
    environment:
      - FLOW_NEXUS_API_URL=https://flow-nexus.ruv.io
    networks:
      - claude-flow-net
    profiles:
      - nexus
    command: tail -f /dev/null

volumes:
  claude-flow-hive:
    name: claude-flow-hive
  claude-flow-swarm:
    name: claude-flow-swarm
  claude-flow-memory:
    name: claude-flow-memory
  claude-flow-coordination:
    name: claude-flow-coordination
  flow-nexus-data:
    name: flow-nexus-data

networks:
  claude-flow-net:
    name: claude-flow-network
    driver: bridge
